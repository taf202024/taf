<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scatta Foto e Aggiungi Annotazioni</title>
    <style>
        #videoElement, canvas {
            border: 1px solid black;
            max-width: 100%;
            height: auto;
        }
        #controls {
            margin-top: 10px;
        }
        #actions {
            margin-top: 15px;
        }
        #textInputDiv {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h2>Scatta una foto con la fotocamera</h2>

    <!-- Video stream dalla fotocamera -->
    <video id="videoElement" autoplay></video>

    <!-- Pulsante per scattare la foto -->
    <button id="snapButton">Scatta Foto</button>

    <!-- Canvas per visualizzare l'immagine catturata -->
    <canvas id="imageCanvas" style="display: none;"></canvas>

    <!-- Sezione per aggiungere annotazioni -->
    <div id="actions" style="display: none;">
        <h3>Aggiungi Annotazioni</h3>
        <button id="annotateButton">Disegna Linee Rette</button>
        <button id="dimensionButton">Disegna Linea di Quotatura</button> <!-- Nuovo pulsante per linee di quota -->
        <button id="textButton">Aggiungi Testo</button>
        <button id="deleteButton">Cancella Oggetto</button>
        <button id="editButton">Modifica Oggetto</button>
        <button id="saveButton">Salva Immagine</button>

        <!-- Controlli per colore e spessore -->
        <div id="controls">
            <label for="lineColor">Colore Linea:</label>
            <input type="color" id="lineColor" value="#ff0000">
            
            <label for="lineWidth">Spessore Linea:</label>
            <input type="range" id="lineWidth" min="1" max="10" value="2">
        </div>
    </div>

    <!-- Input per il testo -->
    <div id="textInputDiv" style="display: none;">
        <input type="text" id="inputText" placeholder="Inserisci il testo" />
        <button id="addTextButton">Aggiungi il testo</button>
    </div>

    <script>
        // Seleziona elementi HTML
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('imageCanvas');
        const snapButton = document.getElementById('snapButton');
        const ctx = canvas.getContext('2d');
        const actions = document.getElementById('actions');
        const annotateButton = document.getElementById('annotateButton');
        const dimensionButton = document.getElementById('dimensionButton'); // Nuovo pulsante per le linee di quota
        const textButton = document.getElementById('textButton');
        const deleteButton = document.getElementById('deleteButton');
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const textInputDiv = document.getElementById('textInputDiv');
        const inputText = document.getElementById('inputText');
        const addTextButton = document.getElementById('addTextButton');
        const lineColorInput = document.getElementById('lineColor');
        const lineWidthInput = document.getElementById('lineWidth');

        let isDrawing = false;
        let isAddingText = false;
        let startX, startY, currentX, currentY;
        let selectedObject = null;
        let objects = []; // Array per memorizzare linee e testi

        // Classe per linee, testi e linee di quotatura
        class Drawable {
            constructor(type, startX, startY, endX, endY, color, lineWidth, text) {
                this.type = type; // "line", "dimension" o "text"
                this.startX = startX;
                this.startY = startY;
                this.endX = endX;
                this.endY = endY;
                this.color = color;
                this.lineWidth = lineWidth;
                this.text = text; // Usato solo per i testi e le linee di quotatura
            }

            draw(ctx) {
                if (this.type === 'line') {
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = this.lineWidth;
                    ctx.beginPath();
                    ctx.moveTo(this.startX, this.startY);
                    ctx.lineTo(this.endX, this.endY);
                    ctx.stroke();
                } else if (this.type === 'dimension') {
                    // Disegna la linea di quota con frecce
                    this.drawDimension(ctx);
                } else if (this.type === 'text') {
                    ctx.font = `${this.lineWidth * 10}px Arial`; // Spessore influenzerà la dimensione del testo
                    ctx.fillStyle = this.color;
                    ctx.fillText(this.text, this.startX, this.startY);
                }
            }

            // Funzione per disegnare le frecce
            drawArrowhead(ctx, fromX, fromY, toX, toY, arrowWidth, arrowHeight) {
                const angle = Math.atan2(toY - fromY, toX - fromX);
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - arrowWidth * Math.cos(angle - Math.PI / 6), toY - arrowWidth * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - arrowHeight * Math.cos(angle), toY - arrowHeight * Math.sin(angle));
                ctx.lineTo(toX - arrowWidth * Math.cos(angle + Math.PI / 6), toY - arrowWidth * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            }

            // Disegna la linea di quotatura con frecce e testo centrale
            drawDimension(ctx) {
                ctx.strokeStyle = this.color;
                ctx.lineWidth = this.lineWidth;

                // Disegna la linea
                ctx.beginPath();
                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(this.endX, this.endY);
                ctx.stroke();

                // Disegna le frecce alle estremità
                const arrowWidth = 10;
                const arrowHeight = 20;
                ctx.fillStyle = this.color;
                this.drawArrowhead(ctx, this.startX, this.startY, this.endX, this.endY, arrowWidth, arrowHeight);
                this.drawArrowhead(ctx, this.endX, this.endY, this.startX, this.startY, arrowWidth, arrowHeight);

                // Calcola il centro della linea per il testo
                const midX = (this.startX + this.endX) / 2;
                const midY = (this.startY + this.endY) / 2;
                const angle = Math.atan2(this.endY - this.startY, this.endX - this.startX);

                // Ruota il contesto per il testo
                ctx.save();
                ctx.translate(midX, midY);
                ctx.rotate(angle);
                ctx.font = `${this.lineWidth * 10}px Arial`;
                ctx.fillText(this.text, -ctx.measureText(this.text).width / 2, -5);
                ctx.restore();
            }

            isSelected(x, y) {
                if (this.type === 'line' || this.type === 'dimension') {
                    // Controlla se il punto (x, y) è vicino alla linea
                    const distance = Math.abs((this.endY - this.startY) * x - (this.endX - this.startX) * y + this.endX * this.startY - this.endY * this.startX) / 
                                     Math.sqrt(Math.pow(this.endY - this.startY, 2) + Math.pow(this.endX - this.startX, 2));
                    return distance < 5; // Tollerenza di 5 pixel
                } else if (this.type === 'text') {
                    // Controlla se il punto è vicino al testo
                    const textWidth = ctx.measureText(this.text).width;
                    const textHeight = this.lineWidth * 10; // Altezza stimata del testo
                    return x >= this
